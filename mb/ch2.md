第2章  比特币是如何工作的
=======


##交易，区块，挖矿以及区块链

比特币系统不像传统银行系统和支付系统，是基于去中心化的信任的。与传统中央权威信任机构相反，比特币的信任是以一种自然属性的方式获得的，这种自然属性来源于比特币系统不同参与者间的交互。在本章中，我们将从较高的水平上在比特币系统中跟踪一笔交易，看它如何变为“被信任”，被比特币的分布式共识机制接受，最后被记录到所有交易的分布式账本中，也就是区块链上。

每个例子均基于在比特币网络上执行的一个真实交易，模拟了用户间（乔，爱丽丝，鲍勃），资金从一个钱包进入另一个钱包的一种交互过程。当在比特币网络和区块链中跟踪交易时，我们利用区块链浏览器网站来可视化的展现每个步骤。区块链浏览器是一个web应用，起到了比特币的搜索引擎的作用，利用它，可以搜索地址，交易，区块以及查看他们间的关系和流程。

流行的区块链浏览器包括：
* Blockchain info
* Bitcoin Block Explorer
* insight
* blockr Block Reader

其中的任何一个均有搜索功能，可以依据地址，交易哈希值，区块号码进行搜索，并且在网络和区块链中搜到的数据是一样的。在每个例子中，我们会提供一个URL，让你直接找到相应的入口，以便对细节进行进一步研究。

###比特币概览

在下述概览图（图2-1）中，我们可以看到，比特币系统由用户、交易和矿工组成。用户拥有钱包，钱包中包含了用户的密钥；交易在网络中传播；矿工通过竞争性计算来创建共识区块链，它是所有交易的权威账本。在本章中，我们将在较高的水平上跟踪一个交易在网络中的旅行并且检查由此引起的比特币系统不同部分的交互。接下来的章节中，我们将深入了解钱包、挖矿和商户系统后更多的技术细节。

![figure 2-1](fig2-1.png)

*图2-1 比特币概览*

###购买一杯咖啡
爱丽丝，这位我们之前已经介绍过的主角，是一个新用户，她刚刚取得了她的第一笔比特币。在第9页的《获取你的第一笔比特币》中，爱丽丝遇到了她的朋友乔，并用现金跟他交换了一笔比特币。那笔由乔创建的交易往爱丽丝的钱包中存进了0.10的比特币（BTC）。现在爱丽丝将进行她的第一笔零售交易---在鲍勃位于加州帕洛阿尔托的咖啡店中购买一杯咖啡。鲍勃的咖啡店最近刚开始接受比特币支付，他在销售系统上添加了比特币的选项。咖啡店的价格是以当地货币（美元）标注的，但是在收银处，客户可以选择以美元或者比特币进行支付。销售系统将自动依据主流市场的汇率，将美元价格转换为比特币价格，并同时显示两种价格，销售终端还显示一个带有本笔支付请求的二维码到屏幕上：

	合计:
	$1.50 美元
	0.015 比特币

![figure 2-2](fig2-2.png)

*图2-2 支付请求二维码（提示：扫扫看）*
	
	支付二维码按照BIP0021的要求，将以下URL进行编码：

    bitcoin:1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA?
	amount=0.015&
	label=Bob%27s%20Cafe&
	message=Purchase%20at%20Bob%27s%20Cafe

	URL的组成元素
	比特币地址：1GdK9UzpHBzqzX2A9JFP3Di4weBwqgmoQA
	支付金额：“0.015”
	接收人地址的标签："鲍勃咖啡店”
	支付描述：“在鲍勃咖啡店买东西”

![notes](notes.png)不像一个只包含目标地址的地址二维码，支付请求二维码是一个二维码编码的URL，包含了目标地址，支付金额，一个通用描述，如“鲍勃咖啡店”。比特币钱包软件可以使用这些信息预填充用于发送支付指令的信息，同时也可以人工可读的方式显示给用户。你可以使用一个钱包软件扫描二维码，看看爱丽丝看到了什么。

鲍勃说：“共1.5美元或者15毫比特币。”

爱丽丝用她的智能手机在屏幕上扫了一下二维码，手机显示需要支付0.0150比特币给鲍勃咖啡店，她选择发送，授权了这笔支付交易。几秒钟后（与刷信用卡授权的时间差不多），鲍勃在收银机上看到了这笔交易，交易完成了。

在接下来的章节中，我们将更细节的去剖析这笔交易，看爱丽丝的钱包是如何构建这笔交易，如何将它广播到网络中，如何确认，最后鲍勃是怎么才能在后续交易中使用这笔钱的。

![bird](bird.png)*比特币网络可以支持零钱交易，比如，从毫比特币（一个比特币的千分之一）一直到一个比特币一亿分之一（通常称为聪币）。在本书中，我们用比特币指代任何数量的比特币货币，从最小的单位（1聪币）到全部可被挖出的数量（2100万）。*

##比特币交易

简单的说，一个交易，就是告诉网络，某个拥有一定数量比特币的用户已经授权将这笔比特币转让给另一位用户。新的所有者可以通过另外一笔交易进行授权转让的方式来使用这些比特币，以此类推，形成一个所有者转换的链条。

交易就像复试账本的一笔笔记录，每个交易均包含一到多条“输入”--这是比特币账户的借方。另一方面，每笔交易也包含了一到多条“输出”--这是比特币账户的贷方。输入和输出（借和贷）加起来不要求相等，相反的，输出加起来的和应稍小于输入的和，这个差异代表了隐含的“交易费用”，这笔小额费用归将交易归集到账本的矿工所有。以复试账本表示的比特币交易如图2-3.

交易同样包括输入域中每笔代转让资金金额的所有权证明，这种证明以所有者数字签名的方式来表示，数字签名可以被任何人独立验证。在比特币的术语中，“消费”就是签署一笔交易，交易将所有者从前序交易中获取的价值权益转让给以比特币地址代表的新所有者。

![notes](notes.png)交易将价值从交易输入移动到交易输出。一个交易输入是价值的来源，通常是上一笔交易的输出。交易输出将一笔与私钥关联的价值赋给一个新用户。目标密钥被称为产权证明。在未来的交易中，需要通过签名来获取这笔资金。交易的输出可以作为新交易的输入，这样价值不断从一个地址转移到另一个地址，形成了一条拥有者的链条（见图2-4）。

![figure 2-3](fig2-3.png)

*图2-3 交易作为一个复式账簿*

![figure 2-4](fig2-4.png)

*图2-4 一个交易链，一个交易的输出作为下一笔交易的输入。*

爱丽丝支付给鲍勃咖啡的交易使用了上一笔交易的输出作为这笔交易的交易输入。在上一章中，爱丽丝从他们的朋友乔那边用现金换到了一笔比特币。那个交易的一笔资金被爱丽丝的密钥锁定。她是否给鲍勃咖啡的新交易引用上笔交易的输出作为本笔交易的输入，输出则包含两部分，一部分是支付开发费用，另一部分用于找零。交易形成了一个链条，输入就是最近的上笔交易的输出。爱丽丝的密钥提供的签名接受了前序交易的输出，这使得比特币网络可以确认她对这些资金的所有权。她在交易中附上鲍勃的地址，这样就限制了鲍勃必须使用签名解锁这个输出才能使用这笔资金。这个过程展示了价值在爱丽丝和鲍勃中转移的过程。这个从乔到爱丽丝在到鲍勃的交易链见图2-4。

###常见交易形式
最常见的交易就是从一个地址到另一个地址的支付，它通常还包含一定需要返还给初始所有者的零钱。这种类型的交易包含一个输入和两个输出，参见图2-5.

![figure 2-5](fig2-5.png)

*图2-5 最常见的交易

另外一种常见交易形式是绑定几个输入，形成一个输出（见图2-6）。这是现实生活中将零钱换为大额钞票的场景。这种交易通常是钱包软件将交易中找回的一堆零钱换成一个大额以清理的情况。

![figure 2-6](fig2-6.png)

*图2-6 归集资金的交易*

最后，另外一个在比特币账本中常见的交易是将一个输入转换为多个代表不同接收者的输出（见图2-7）。这种类型的交易有时是商业实体用于分发资金，比如给员工发工资。

![figure 2-7](fig2-7.png)

*图2-7 分发资金交易 *

##创建交易

爱丽丝的钱包软件拥有各种逻辑以选择合适的输入和输出以创建符合爱丽丝要求的交易。爱丽丝需要做的只是指定一个接收人和交易金额，剩下工作的钱包软件会自动完成而不需要让她看到细节。很重要的，钱包软件甚至在离线的情况下也可以创建交易。就像在家里写一张支票，然后将其装进信封寄给银行，交易不需要在连接到比特币网络的情况下进行创建和签名。它只需要最终将交易发送到网络已进行最后执行。

###获得正确的输入
爱丽丝的钱包软件必须首先找到能够支付给鲍勃的金额的输入。大部分钱包软件会保留一个“未使用的交易输出”的小数据库，它们由钱包所有者的私钥锁定。这样，爱丽丝的钱就包含有那笔她用现金跟乔交换比特币的交易输出的拷贝（参见第9页”获取你的第一笔比特币”）。一个运行在全索引模式客户端下的比特币钱包软件实际上区块链上包含交易的“未花费的输出”。这使得钱包软件不仅能快速构建交易输入，也能验证一个新来的交易的输入是有效的。但是，一个全索引客户端需要耗费非常多的存储空间，大部分用户钱包只是运行轻量客户端，只能跟踪用户自己的未花费的输出。

如果一个钱包应用没有维护完整的“未花费的输出”，它可以使用不同供应商提供的API接口向比特币网络询问这些信息，或者也可以使用JSON RPC接口向一个全索引节点询问相关信息。例2-1展示了一个RESTful API请求，它以HTTP GET命令的方式构造一个请求发往特定的URL地址。这个URL将根据请求中的地址信息返回所有“未花费的输出”信息，供任何需要使用这些信息构造交易输入的应用使用。我们在这里使用简单的命令行模式的HTTP客户端cURL来获取应答。

*例2-1 寻找爱丽丝比特币地址下所有未花费的输出*
	$curl https://blockchain.info/unspent?active=1Cdid9KFAaatwczBwBttQcwXYCpvK8h7FK

*例2-2 请求应答*

	{
	"unspent_outputs":[
			{
			"tx_hash":"186f9f998a5...2836dd734d2804fe65fa35779",
			"tx_index":104810202,
			"tx_output_n": 0,
			"script":"76a9147f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a888ac",
			"value": 10000000,
			"value_hex": "00989680",
			"confirmations":0
			}
		]
	}

例2-2的应答显示只有一个归属于爱丽丝的地址1Cdid9KFAaatwczBwBttQcw
XYCpvK8h7FK下的“未花费的输出”（尚未兑现的输出）。应答还包含了产生这笔输出的交易引用（乔发起的支付交易），它的以聪计算的价值，1000万聪，也就是0.10比特币。利用这些信息，爱丽丝的钱包应用可以构建一个交易向新的所有者地址发送价值了。

![notes](notes.png)[参看乔到爱丽丝的交易](http://bit.ly/1tAeeGr)

就像你看到的，爱丽丝钱包中单一的未花费的输出已足够支付一杯咖啡的费用。如果这个条件不能满足，钱包软件就不得不去翻找所有小额未花费输出凑够这笔交易输入，就像从手提袋中翻找足够的硬币来凑够一杯咖啡的钱。在两种情况下，钱包软件都都可能需要在交易输出中找回一些零钱，我们将在下节讨论。


###创建输出

交易输出以一种脚本的形式锁定一个价值的所有权证明，它只能通过解决脚本问题来解除锁定。简单的说，爱丽丝的交易输出包含一个脚本，脚本大概意图是这样的：“这个输出将支付给那个能提供与鲍勃的公开地址匹配的签名的人”。由于只有鲍勃拥有与其地址对应的密钥，所以只有鲍勃的钱包可以提供这样一个签名来解锁这笔输出。爱丽丝就可以以要求提供签名的方式，锁定了一笔输出价值。

这笔交易还包含另一部分，因为爱丽丝的资金是以0.10比特币表示的一个输出，超过了一杯咖啡0.015比特币的数额。爱丽丝需要拿回0.085比特币的找零。爱丽丝的找零操作是由钱包在生成给鲍勃支付的交易时同时生成的。本质上看，爱丽丝的钱包将她的资金分成两笔支付，一笔给鲍勃，剩下的交还她自己。她可以在下一笔交易中使用这个找零输出。

最后，为了这笔交易尽快被网络执行，爱丽丝的钱包应用将添加一个小笔的交易费用。这个过程不是显式的，它隐含于交易输入输出的差值中。假如交易中找零金额不是填0.085，而是用0.0845作为交易第二个输出（找零输出），这样就有0.005比特币（半毫比特）的剩余。输入的0.10比特没有被两个输出完全花费完，因为它们加起来不到0.10。结构的差异就构成了交易费用，矿工们在将这笔交易加入到区块，并放入区块链账本的过程中会收集这些交易费用作为它们挖矿的补偿。

交易结果可以通过区块链浏览器web应用来查看，如图2-8：

![figure 2-8](fig2-8.png)

*图2-8 爱丽丝给鲍勃咖啡店付款的交易*

![notes](notes.png)[查看爱丽丝给鲍勃咖啡店付款的交易](http://bit.ly/1u0FIGs )

###将交易添加到账本上
爱丽丝钱包应用创建的交易共258字节长，它包含所有必须的用于确认她的资金所有权以及资金接收者的信息。现在，交易必须发送到比特币网络上并使之成为分布式账本（区块链）的一部分。在接下来的一节中，我们将看到一个交易时如何变成新区快的一部分，以及区块是如何通过挖矿挖出。最后，我们还将看到这个新区快一旦被加入到区块链后，是如何随着区块的增加而变得越来越可信的。

####发送交易
因为交易已包含所有用于后续处理的信息，所以不要关心它是如何或者从哪里传入比特币网络的。比特币网络是一个点对点的网络，每个比特币客户端通过连接到不同的客户端成为网络的参与者。比特币网络的目标就是把交易和区块广播给所有的参与者。

####如何广播

爱丽丝的钱包应用可以将新交易发送到所有通过互联网与它相连的客户端：不管是有线、WiFi，移动网络均可。她的比特币钱包不一定非要与鲍勃的钱包直接相连，她也不必非要使用咖啡店提供的互联网接入，虽然这两种方式也没什么不可以。任何比特币网络节点（其他客户端）接收到有效的，它尚未见过的的交易时将立马将其转发给与它相连的其他客户端。这样，交易就很快在这个点对点网络中广播，在短短几秒内即可到达大部分节点。


####鲍勃的视角


第四章 密钥，地址，钱包
======
## 简介
比特币的拥有证明是基于数字密钥，比特币地址以及数字签名。数字密钥实际上并不存储于网络上，而是由用户创建并以文件或者简单数据库的形式由用户自行保存， 叫做钱包。用户钱包中的数字密钥是完全独立于比特币协议的，它可以由钱包软件创建、管理，而无需与区块链关联或者访问互联网。密钥的存在使比特币的很多特性 得以实现，包括去中心化的信任和控制，持有证明，密码学证明的安全模型等等。

每个比特币交易均需要在在区块链中包含一个有效的签名，这个签名由有效的数字密钥产生，这样，任何一个拥有密钥的人均拥有这个比特币账户中比特币的控制权。 密钥是成对出现的，包含一个私钥（秘密的）和一个公钥。我们可以把公钥想象成一个银行账户的代号，私钥则是这个账户密码，或者支票上用户签名。这些数字密钥 极少被比特币用户看到，实际上，大部分时候，他们存储在钱包文件中，并且由钱包软件进行管理。

在比特币的支付环节，接收者的公钥是由其指纹所代替的，称为比特币地址，它就像支票上的接收人名称（“收款人”）。大多数时候，比特币地址是从私钥产生并与之关联的，但是也可以代表其它“受益人”，比如稍后我们将在本章中将见到的“脚本”。通过这种方式，比特币地址作为接收人的一个抽象表示，使得交易对手更为灵活，类似于纸质支票：一个单一的支付指令既可用于向个人账户付款也可以用于向公司账户付款，既可以账单支付，也可以现金支付。比特币地址是用户可见的唯一表现形式，因为它是需要于公众共享的部分。

在本章中，我们将介绍包含密码学密钥的钱包，我们也将介绍密钥是如何产生，存储和管理的，我们也将看到各种用于公私钥、比特币地址、脚本地址的编码格式；最后，我们将对密钥的特定使用场景、消息签名、所有权证明、创建“炫耀”地址和纸质钱包进行综述。

## 公钥密码学和加密货币

公钥密码学诞生于上世纪70年代，是计算机和信息安全的数学基础。

自公钥密码学发明以来，素数幂、椭圆曲线运算等合适的数学函数路线被发现，这些函数都是不可逆的运算，也就是说，我们很容易从一个方向进行计算得出结果，单色反过来却无法通过结果反向计算得出原文。基于这些数学函数，密码学使得数字密码和不可伪造签名的创建成为可能。比特币使用椭圆曲线运算作为其公钥密码学的基础。

在比特币中，我们利用公钥体系来控制对比特币的访问权。密钥对由私钥和公钥（由私钥派生而来）组成，公钥用于接收比特币，私钥用于对支付比特币的交易进行签名。

在数学上，公私钥间的关系是这样的：私钥用于生成消息签名，公钥在不依赖于私钥的前提下，可以对该签名的有效性进行验证。

当需要支付比特币时，比特币的持有人需要随同交易同时提供公钥和签名（签名每次不同，但都由相同的私钥创建）。通过公钥和签名，比特币网络中的所有参与人都可以验证该笔交易的资金在交易发起时点确实由发起人拥有，由此确认交易的有效性，并接受该笔交易。

---
&nbsp; |&nbsp;
---|---
![image](https://raw.githubusercontent.com/picocn/furry-potato/alpha/mb/tips.png)|*在大部分钱包的实现中，私钥和公钥是存储在一起的，但是由于公钥可以由私钥计算得来，因此只存储私钥也是可行的*

---

## 私钥和公钥
  一个比特币钱包通常是一系列密钥对的集合，每个密钥对包含一个私钥和一个公钥，私钥(k)，是个数字，通常随机获取。从私钥出发，利用椭圆曲线运算（一种单向加密函数），可以计算得出一个公钥（K），从公钥出发，利用单向密码哈希函数生成比特币地址（A），在本节中，我们从生成私钥开始，接着研究生成公钥的椭圆曲线函数，最后从公钥生成一个比特币地址。

私钥、公钥、比特币地址的关系见下图

```
sequenceDiagram
k->>K: yes
K->>A: yes
A->>K: no
K->>k: no
```

## 私钥
一个私钥就是一串随机生成的数字，拥有和控制私钥是用户控制与比特币地址关联的所有资金的根本。用户交易时需要证明其使用的资金是他自己的，这就需要使用其私钥对交易进行签名，私钥在任何时候军必须保证其私密性，因为将其透露给第三方也就等同于吧对比特币的控制权交给了第三方。私钥同样要进行备份以防意外丢失，如果私钥丢失，将是不可恢复的，受它保护的资金也就彻底丢失了。

---
&nbsp; |&nbsp;
---|---
![image](https://raw.githubusercontent.com/picocn/furry-potato/alpha/mb/tips.png)|*比特币私钥只是一串数字，你甚至可以利用硬币、铅笔和纸张的来随机获取：抛256次硬币，你就拥有了意义用于比特币中使用的私钥的二进制值。生成私钥后，相应的公钥就可以利用私钥计算得出*

---
### 从一个随机数生成私钥

从随机数生成私钥最关键的一部是找到一个安全的熵源（或者叫随机源），创建比特币秘钥本质上就是取得一个0到2^256之间的数字。如果能保证随机数获取的方式是不可预测、不可重复的，则实际采用哪种方法无关紧要。比特币软件利用操作系统底层的随机数生成器来生成256比特的熵（随机数），通常操作系统的随机数利用一种人工随机源进行初始化，这也是为什么生成的过程中要你随机晃动鼠标几秒钟。对于真正的偏执狂，其实没有什么比骰子、铅笔和纸张更靠谱了。

更确切的说，私钥是从1到n-1之间的任意数字，其中n是一个常量（n=1.158*10^77,比 2^256 略小），在比特币中这个常量是作为椭圆曲线的幂来定义的（参见p65，椭圆曲线密码学解释）。为了生成这样一个密钥，我们随机取一个256比特长度的数字，并验证其是否小于n-1。以程序的术语，这通常是从一个密码学安全的随机源中抽取一长段字符串并填充到SHA256哈希算法中，这样将很方便的生成一个256比特长度的数字。如果上述步骤结果小于n-1，我们就得到了一个合适的私钥。否则，我们只要重复以上步骤最终将得到一个合适的私钥。

---
&nbsp; |&nbsp;
---|---
![image](https://raw.githubusercontent.com/picocn/furry-potato/alpha/mb/tips.png)|*不要试图自己写代码生成密钥或者采用编程语言提供的“简单”的随机数生成器。采用密码学安全的伪随机数生成器（CSPRNG），并且从足够的熵源中提取随机数种子。仔细研究你的随机数生成库的文档，以确定你选择的随机数生成器是密码学安全的。正确选择的CSPRNG算法对于密钥的生成至关重要。*

以下是以十六进制形式表示的随机生成的私钥(k)（256比特的二进制数字用十六进制表示共有64位，每位代表4比特）：
> 1E99423A4ED27608A15A2616A2B0E9E52CED330AC530EDCC32C8FFC6A526AEDD

---
&nbsp; |&nbsp;
---|---
![image](https://raw.githubusercontent.com/picocn/furry-potato/alpha/mb/tips.png)|*比特币私钥占用的空间，2^256 是一个难以想象的大数，以十进制表示，它大概是10^77， 而可见的宇宙大概是由10^80 个原子构成的*

为了使用比特币的核心客户端创建一个新的密钥，可以使用getnewaddress命令。出于安全考虑，命令输出只显示公钥，私钥不显示。要让bitcoind进程暴露私钥，使用dumpprivkey命令。dumpprivkey命令以"Base58校验和"(Base58 checksum-encoded)编码格式表示密钥，叫做钱包导入格式（Wallet Import Format, WIF)，我们将在P76的“私钥格式”中进一步详细介绍。以下例子展示了利用上述两个命令生成和显示私钥的步骤：
> $ bitcoind getnewaddress

> 1J7mdg5rbQyUHENYdx39WVWK7fsLpEoXZy

> $ bitcoind dumpprivkey 1J7mdg5rbQyUHENYdx39WVWK7fsLpEoXZy

> KxFC1jmwwCoACiCAWZ3eXa96mBM6tb3TYzGmf6YwgdGWZgawvrtJ

dumpprivkey命令打开钱包并且解压出由getnewaddress生成的私钥。bitcoind是无法通过公钥知道私钥的，除非它们同时存储于钱包中。

---
&nbsp; |&nbsp;
---|---
![image](https://raw.githubusercontent.com/picocn/furry-potato/alpha/mb/tips.png)|*dumpprivkey命令不是从公钥生成一个私钥，因为这根本不可能。这个命令只是简单的从“钱包”中取出由getnewaddress生成的私钥。*

你也可以使用命令行工具sx（参见p56，libbitcoin和sx工具）来生成和展示私钥；相应的sx命令是newkey：
> $ sx newkey

> 5J3mBbAH58CpQ3Y5RNJpUKPE62SQ5tfcvU2JpbnkeyhfsYB1Jcn

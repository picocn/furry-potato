第5章 交易
=======

#介绍

交易是比特币系统中最重要的部分。所有其他部分都是设计来保证交易能够创建，在网络中广播，验证，最后加入到全局交易账本（区块链）。交易是一个数据结构，用于将比特币系统中不同参与者间价值传递进行编码。每个交易军事比特币的区块链中的一条公开记录，区块链是一个全局的复试簿记账本。

在本章中，我们将检查各种形式的交易，它们包含什么内容，如何创建，如何验证，以及它们是如何成为所有交易的永久记录的一部分的。

#交易生命周期
交易的生命周期开始于交易的创建，也称之为起源。然后交易被签署上一个到多个签名，用于表明对交易中引用资金的授权。接着交易被广播到比特币网络中，在网络中，所有网络节点（参与者）对交易进行验证并继续广播此交易，直到达到（几乎）网络中的所有节点。最后，交易被矿工节点确认，并被包含到一个交易区块中，记录到区块链上。

一旦在区块链上记录，并被足够的后续区块确认后，交易将成为比特币账本的永久组成部分，可以被所有参与者作为有效交易而被接受。于是，交易中分配给新所有者的资金可以在新的交易交易中使用。就这样，所有者链条得以延伸，交易的一个新的生命周期开始了。

##创建交易
将比特币交易想象成纸质支票，有助于帮助理解交易。就像一张支票，交易是一种表达资金转移意愿的工具，在提交执行前，它对金融系统是透明的。也像一张支票，交易的发起人不一定是对交易进行签名的人。

任何人均可以在线或离线创建交易，甚至创建交易的人不是账户的有权签署人。举例来说，应付账款办事员可能需要处理一笔需要CEO签字的支付支票。相似的，应付账款办事员也可以创建一笔比特币交易，然后经过CEO的数字签名使得交易生效。不同的是，支票需要关联一个账户作为其资金来源，而比特币交易是引用一个特定的前序交易作为其资金来源，而不是账户。

一旦交易被创建，它将被资金来源的所有者签名。如果正确组织并被签名，签名后的交易就是有效的了，它包含了用于执行资金的转移的所有必须的信息。最后，有效交易必须送达比特币网络，并被传播出去，直到被一个矿工包含到公开账本（区块链）之中。

##将交易广播到比特币网络

首先，交易需要传到比特币网络中以便被传播并包含进区块链。本质上，一个比特币交易只有300到400字节的数据，需要被传播到成千上万的比特币节点。发送者不需要信任用于广播交易的节点，只要他们使用超过一个节点确保交易被广播出去就行。接收节点也不需要信任发送者或者确认他们的“身份”。因为交易已被签名并且不含任何机密信息，比如私钥，证书，它可以通过任何方便的底层网络传输协议进行公开广播。不像信用卡交易，它包含敏感信息，只能通过加密网络传输数据，比特币交易却可以在任何网络上传输数据。只要交易能到达一个能将其广播到比特币网络的节点，它是如何传递到第一个节点的，并不需要在乎。

从而比特币交易可以通过不安全的网络传输到比特币网络中，比如WiFi，蓝牙，NFC，调频，条形码，甚至拷贝粘贴到一个web表单中。在极端情况下，比特币交易还可以通过无线电分组交换网、卫星中继，或者突发短波、扩频，或者防止检测和干扰的跳频进行数据传输。比特币交易甚至也可以编码为一段表情符号（情感符），发布到公共论坛上，或者以文本消息或者Skype消息的形式发送。比特币将货币转换成一个数据结构，使的实际上无法阻止任何人创建或执行比特币交易。

##在比特币网络中传播交易
一旦比特币交易发送到任一与比特币网络相连的节点，交易就将被这个节点进行验证，如果有效，这个节点会将其传播到其他相连的节点上，交易发起者会同步接收到一个成功应答。如果交易无效，接收节点将拒绝交易并同时返回一个交易拒绝消息给交易发起者。

比特币网络是一个点对点网络，意味着每个节点均与其他一些启动时通过点对点协议发现的节点相连。整个网络构成一个松散连接的网状结构，没有固定的拓扑或其他结构，使得所有节点都是平等的。小写，包括交易和区块从一个节点被传播到与之相连的节点上。新注入到网络中任何节点的有效交易简便发送到三到四个相邻节点，每个相邻节点又再次将其发送到三到四个新的相邻节点，以此类推。利用这种方式，在短短几秒内，一个有效交易像指数级扩散的波纹一样在网络中迅速传播，直到到达所有连接着的节点。

比特币网络被设计成可以高效、弹性的方式在所有节点间传播交易和区块，同时它又能够有效防止攻击。为防止网络垃圾、拒绝服务攻击、或者其他针对系统的恶意攻击，每个节点均在传播交易前先进行独立验证。有缺陷的交易将无法传出节点。这个交易验证规则将在第177页《独立交易验证》中进行详细解释。

#交易结构
一个交易就是一个数据结构，它用于对从资金源到目标的价值传递进行编码，其中资金源在交易中被称之为*输入*，目标被称之为*输出*。交易输入和输出与账户或者用户身份没有关联性。相反的，你应该把它们想象为交易金额，一组比特币，被一个特定的密钥锁定，只有所有者，或者知道那个密钥的人才能进行解锁。一个交易包含一系列字段，如表5-1所示：

|大小|字段|描述|
|----|----|------|
|4字节|Version|指定这个交易需要遵循那个规则|
|1-9字节|Input Counter|有多少输入|
|可变长度|Inputs|一个或多个交易输入|
|1-9字节|Output Counter|有多少输出|
|可变长度|Outputs|一个或多个交易输出|
|4字节|Locktime|Unix时间戳或者区块号|

|交易锁定时间（Transaction Locktime）|
|----|
|锁定时间定于一个交易可以被加入区块链的最早时间。大多数交易此值设置为0，意指立即执行。如果锁定时间一个非0，并且小于5亿，它被解释为区块高度，意思是交易不要被包含进指定高度以下的区块中。如果大于5亿，它是一个Unix时间戳（从1970.1.1以来的秒数），代表交易不要在这个时间前被加入到区块链中。锁定时间的使用等同于支票的延期支付。|

#交易输入和输出
比特币交易的基本构架单元是*未花费交易输出*，或者叫UTXO，UTXO是一个不可拆分的比特币货币块，锁定到一个特定的所有者，记录在区块链上。